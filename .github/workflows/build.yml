name: Build and Test UV Viewer

on: [push, pull_request]

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - uses: actions/checkout@v2
    
    - name: Set up Python
      uses: actions/setup-python@v2
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install PyQt5 numpy pyopengl scipy
    
    - name: Create and run UV display test
      run: |
        # Create the test file
        cat > test_uv_display.py << 'EOF'
        import numpy as np
        import sys
        from PyQt5.QtWidgets import (QApplication, QWidget, QVBoxLayout, QHBoxLayout, 
                                     QPushButton, QLabel, QTextEdit, QOpenGLWidget)
        from PyQt5.QtCore import Qt
        from OpenGL.GL import *
        from OpenGL.GLU import *

        class SimpleOpenGLUVViewer(QWidget):
            def __init__(self):
                super().__init__()
                self.setWindowTitle("UV Test - Simple OpenGL")
                self.setGeometry(100, 100, 800, 600)
                
                layout = QVBoxLayout(self)
                
                self.test_btn = QPushButton("Test UV Display")
                self.test_btn.clicked.connect(self.test_uv_display)
                layout.addWidget(self.test_btn)
                
                self.gl_widget = SimpleUVOpenGLWidget()
                layout.addWidget(self.gl_widget)
                
                self.log = QTextEdit()
                self.log.setMaximumHeight(100)
                layout.addWidget(self.log)
                
                self.log_message("Application started. Click 'Test UV Display'")
            
            def log_message(self, message):
                self.log.append(message)
                print(message)
            
            def test_uv_display(self):
                self.log_message("Testing UV display...")
                self.gl_widget.test_draw_triangles()

        class SimpleUVOpenGLWidget(QOpenGLWidget):
            def __init__(self):
                super().__init__()
                self.test_triangles = None
            
            def initializeGL(self):
                print("OpenGL initialized")
                glClearColor(1.0, 1.0, 1.0, 1.0)
                glDisable(GL_DEPTH_TEST)
                glDisable(GL_LIGHTING)
            
            def resizeGL(self, width, height):
                print(f"Resize: {width}x{height}")
                glViewport(0, 0, width, height)
                glMatrixMode(GL_PROJECTION)
                glLoadIdentity()
                glOrtho(0, 1, 0, 1, -1, 1)
                glMatrixMode(GL_MODELVIEW)
                glLoadIdentity()
            
            def paintGL(self):
                print("Painting...")
                glClear(GL_COLOR_BUFFER_BIT)
                glLoadIdentity()
                
                self.draw_boundary()
                
                if self.test_triangles is not None:
                    self.draw_triangles()
                else:
                    self.draw_placeholder()
                
                print("Painting complete")
            
            def draw_boundary(self):
                glColor3f(0.0, 0.0, 1.0)
                glLineWidth(2.0)
                glBegin(GL_LINE_LOOP)
                glVertex2f(0.0, 0.0)
                glVertex2f(1.0, 0.0)
                glVertex2f(1.0, 1.0)
                glVertex2f(0.0, 1.0)
                glEnd()
                glLineWidth(1.0)
            
            def draw_triangles(self):
                print("Drawing triangles...")
                glColor3f(1.0, 0.0, 0.0)
                glBegin(GL_TRIANGLES)
                for triangle in self.test_triangles:
                    for vertex in triangle:
                        glVertex2f(vertex[0], vertex[1])
                glEnd()
            
            def draw_placeholder(self):
                glColor3f(0.5, 0.5, 0.5)
                glLineWidth(3.0)
                glBegin(GL_LINES)
                glVertex2f(0.1, 0.1)
                glVertex2f(0.9, 0.9)
                glVertex2f(0.9, 0.1)
                glVertex2f(0.1, 0.9)
                glEnd()
                glLineWidth(1.0)
            
            def test_draw_triangles(self):
                print("Setting up test triangles...")
                self.test_triangles = [
                    [(0.3, 0.3), (0.7, 0.3), (0.5, 0.7)],
                    [(0.1, 0.1), (0.3, 0.1), (0.1, 0.3)],
                    [(0.7, 0.7), (0.9, 0.7), (0.7, 0.9)]
                ]
                print(f"Test triangles: {self.test_triangles}")
                self.update()

        if __name__ == "__main__":
            app = QApplication(sys.argv)
            window = SimpleOpenGLUVViewer()
            window.show()
            sys.exit(app.exec_())
        EOF
        
        # Run the test (headless - just check if it imports and creates objects)
        python -c "
        import sys
        try:
            from test_uv_display import SimpleOpenGLUVViewer, SimpleUVOpenGLWidget
            print('SUCCESS: UV test classes imported successfully')
            
            # Test creating objects
            app = QApplication(sys.argv)
            viewer = SimpleOpenGLUVViewer()
            widget = SimpleUVOpenGLWidget()
            print('SUCCESS: UV test objects created successfully')
            
            # Test the drawing method
            widget.test_draw_triangles()
            print('SUCCESS: UV drawing test completed')
            
        except Exception as e:
            print(f'FAILED: {e}')
            sys.exit(1)
        "
